<?xml version="1.0" ?>
<LOGIC-05>
  <id>LOGIC-05</id>
  <name>Port House System Logic &amp; Data Management</name>
  <description>Migrate the core house data structures ('House', 'Houses'), their management logic, and their interaction with the map and tile data from wxWidgets to Qt6. This task also includes the logic for the House Brush.</description>
  <dependencies>
    <dependencie>CORE-01</dependencie>
    <dependencie>CORE-03</dependencie>
    <dependencie>CORE-04</dependencie>
    <dependencie>CORE-13-TownSystem</dependencie>
    <dependencie>CORE-BRUSH-FRAMEWORK</dependencie>
    <dependencie>UI-07</dependencie>
  </dependencies>
  <original_input_files>
    <original_input_file>wxwidgets/house.h</original_input_file>
    <original_input_file>wxwidgets/house.cpp</original_input_file>
    <original_input_file>wxwidgets/house_brush.h</original_input_file>
    <original_input_file>wxwidgets/house_brush.cpp</original_input_file>
    <original_input_file>wxwidgets/house_exit_brush.h</original_input_file>
    <original_input_file>wxwidgets/house_exit_brush.cpp</original_input_file>
  </original_input_files>
  <analyzed_input_files>
    <analyzed_input_file>
      <file_path>wxwidgets/house.h</file_path>
      <description>Defines 'House' and 'Houses' (manager) classes.
- 'House' class: Stores 'id' (uint32_t), 'rent' (int), 'name' (std::string), 'townid' (uint32_t), 'guildhall' (bool), 'exit' (Position), and a 'PositionList tiles'. References 'Map*'. Methods include 'getID', 'setID', 'clean' (dissociates tiles), 'addTile', 'removeTile', 'size' (walkable tiles), 'getDescription', 'setExit', 'getExit', 'getEmptyDoorID', 'getDoorPositionByID', 'getTilePositions'.
- 'Houses' class: Manages 'House' objects in a 'HouseMap' (std::map&lt;uint32_t, House*&gt;). References 'Map&amp;'. Methods include 'count', iterators, 'erase', 'find', 'getHouse', 'removeHouse', 'changeId', 'addHouse', 'getEmptyID'.</description>
    </analyzed_input_file>
    <analyzed_input_file>
      <file_path>wxwidgets/house.cpp</file_path>
      <description>Implements 'House' and 'Houses' methods.
- 'Houses' methods: Constructor/destructor, 'getEmptyID' (finds next available ID), 'addHouse', 'removeHouse' (calls 'house-&gt;clean()'), 'changeId', 'getHouse'.
- 'House' methods: Constructor/destructor, 'clean' (updates tiles' house association and exit status), 'size' (counts non-blocking tiles), 'addTile' (sets 'tile-&gt;setHouse(this)'), 'removeTile' (clears 'tile-&gt;setHouse(nullptr)'), 'getEmptyDoorID' (scans items on house tiles), 'getDoorPositionByID', 'getDescription', 'setExit' (updates 'TileLocation::house_exits' on old/new exit tiles, creates tile if needed).</description>
    </analyzed_input_file>
    <analyzed_input_file>
      <file_path>wxwidgets/house_brush.h</file_path>
      <description>Defines the 'HouseBrush' class, inheriting from 'Brush'. Its purpose is to assign a specific house ID to map tiles. It stores a pointer to the 'House' object ('draw_house') that it currently represents. Declares methods for 'draw', 'undraw', 'canDraw', 'setHouse', 'getHouseID', 'getLookID', and 'getName'.</description>
    </analyzed_input_file>
    <analyzed_input_file>
      <file_path>wxwidgets/house_brush.cpp</file_path>
      <description>Implements 'HouseBrush' methods.
- 'setHouse(House* house)': Sets the 'draw_house' pointer.
- 'getHouseID()': Returns the ID of the 'draw_house'.
- 'undraw(BaseMap* map, Tile* tile)': Clears the house ID from the tile ('tile-&gt;setHouse(nullptr)') and sets PZ flag to false. If 'AUTO_ASSIGN_DOORID' is enabled, it also clears door IDs on the tile.
- 'draw(BaseMap* map, Tile* tile, void* parameter)': Assigns the current 'draw_house' to the tile ('tile-&gt;setHouse(draw_house)') and sets its PZ flag to true. If 'HOUSE_BRUSH_REMOVE_ITEMS' is enabled, it removes movable items from the tile. If 'AUTO_ASSIGN_DOORID' is enabled, it assigns an empty door ID to any doors on the tile.</description>
    </analyzed_input_file>
    <analyzed_input_file>
      <file_path>wxwidgets/house_exit_brush.h</file_path>
      <description>Defines the 'HouseExitBrush' class, inheriting from 'Brush'. This brush is used to set the exit position for a specific house. It stores the ID of the house ('draw_house') for which the exit is being set. Declares methods for 'canDraw', 'draw', 'undraw', 'setHouse', 'getHouseID', 'getLookID', and 'getName'. The 'draw' and 'undraw' methods are asserted to 'false' as this brush likely works by directly calling 'house-&gt;setExit()' through a UI interaction rather than a typical brush stroke.</description>
    </analyzed_input_file>
    <analyzed_input_file>
      <file_path>wxwidgets/house_exit_brush.cpp</file_path>
      <description>Implements 'HouseExitBrush' methods.
- 'setHouse(House* house)': Sets the 'draw_house' ID.
- 'getHouseID()': Returns the stored house ID.
- 'canDraw(BaseMap* map, const Position&amp; position)': Checks if an exit can be placed at the given position (tile must exist, have ground, not be a house tile itself, and not be blocking).
- 'draw' and 'undraw' methods assert 'false', indicating they are not meant to be called directly for drawing operations.</description>
    </analyzed_input_file>
  </analyzed_input_files>
  <documentation_references>
    <documentation_reference>Qt Data Structures: https://doc.qt.io/qt-6/qtcore-containers.html (QMap for Houses, QList or QVector for House tiles)</documentation_reference>
    <documentation_reference>QVector3D for positions: https://doc.qt.io/qt-6/qvector3d.html</documentation_reference>
    <documentation_reference>QString for names: https://doc.qt.io/qt-6/qstring.html</documentation_reference>
  </documentation_references>
  <current_functionality_summary>Houses are managed by the 'Houses' class, which holds 'House' objects in a 'std::map'. Each 'House' object stores its ID, name, rent, town ID, guildhall status, a list of 'Position's for its tiles, and an exit 'Position'.
- Adding/removing tiles to a house updates the 'Tile::house_id' and the house's internal list of tile positions.
- Setting a house exit updates flags on the 'TileLocation' of the old and new exit tiles.
- The 'HouseBrush' assigns a selected house ID to tiles, sets the PZ flag, and can optionally remove movable items or auto-assign door IDs. 
- The 'HouseExitBrush' is used to designate a tile as an exit point for a selected house; its actual logic is likely tied to a UI action that calls 'selected_house-&gt;setExit(clicked_tile_pos)' rather than a brush stroke.</current_functionality_summary>
  <definition_of_done>
    <element>'House' and 'Houses' classes are part of 'mapcore', managing house data (ID, name, rent, town ID, guildhall status, tile list, exit position) without UI dependencies.</element>
    <element>'House::addTile' and 'House::removeTile' correctly update 'Tile::house_id' and the house's tile list.</element>
    <element>'House::setExit' correctly updates 'TileLocation::house_exits' for old and new exit tiles.</element>
    <element>House data (including tiles and exits) is correctly serialized to and deserialized from OTBM / auxiliary house XML files.</element>
    <element>'HouseBrush' (Qt6 version inheriting from new 'BaseBrush'): Correctly assigns the selected house ID to tiles. Sets PZ flag on house tiles. Optionally removes movable items and auto-assigns door IDs based on settings.</element>
    <element>'HouseExitTool' (or equivalent UI interaction logic for setting exits): Correctly calls 'selected_house-&gt;setExit(target_pos)'.</element>
    <element>All house-related operations (adding/removing tiles via brush, setting exits, modifying house properties) are undoable via the 'QUndoStack'.</element>
    <element>Unit tests for 'House', 'Houses', and 'HouseBrush' functionalities are implemented and pass.</element>
  </definition_of_done>
  <boilerplate_coder_ai_prompt>Port the House system and House Brush logic to Qt6. Reference 'wxwidgets/house.h', 'wxwidgets/house.cpp', 'wxwidgets/house_brush.h', and 'wxwidgets/house_exit_brush.h'.

1.  **Core 'House' and 'Houses' (Manager) Classes (in 'mapcore'):
    *   'House' class: Attributes ('id', 'name', 'rent', 'townId', 'guildhall', 'exitPos'). Manages a 'QList&lt;QVector3D&gt;' or 'QList&lt;Position&gt;' for its tiles. Needs a 'Map*' reference.
    *   'Houses' class: Manages 'QHash&lt;quint32, House*&gt; m_houses'. Needs a 'Map*' reference.
    *   Implement methods: 'House::addTile(Tile* tile)' (updates 'tile-&gt;setHouseId()', adds to list), 'House::removeTile(Tile* tile)' (clears 'tile-&gt;setHouseId()', removes from list), 'House::setExit(const Position&amp; pos)' (updates 'TileLocation::house_exits' on old/new tiles). 'Houses::addHouse', 'Houses::removeHouse', 'Houses::getHouse', 'Houses::getEmptyID'.

2.  **'HouseBrush' Class (Qt6):
    *   Inherit from a new 'BaseBrush' class.
    *   Store a pointer to the currently selected 'House' object.
    *   'draw(Map* map, Tile* tile)': Sets 'tile-&gt;setHouseId(selectedHouse-&gt;getId())', sets PZ flag. Optionally removes movable items / auto-assigns door IDs per settings.
    *   'undraw(Map* map, Tile* tile)': Clears 'tile-&gt;setHouseId(0)', clears PZ. Optionally clears door IDs.

3.  **House Exit Logic (likely a 'MapTool' or UI Action, not a brush stroke):
    *   Implement logic that, when a house and a tile are selected, calls 'selectedHouse-&gt;setExit(tile-&gt;getPosition())'.

4.  **Undo/Redo:**
    *   All operations modifying house data or tile house assignments (brushing, exit setting) must be commands pushed to a 'QUndoStack'.

5.  **I/O:**
    *   Ensure 'IOMapOTBM' (and any auxiliary XML house format handler) correctly loads 'House' objects into 'Map::m_houses', populates their tile lists, and sets exits. Ensure all data is saved correctly.

Ensure all classes are free of UI dependencies if they reside in 'mapcore'.</boilerplate_coder_ai_prompt>
  <qt_object_notes>Use 'quint32' for IDs. 'QString' for names. 'QVector3D' or custom 'Position' for coordinates. 'QList&lt;Position&gt;' for house tile storage. 'QHash&lt;quint32, House*&gt;' for 'Houses' manager. Integrate house-modifying operations with 'QUndoStack' by creating custom 'QUndoCommand' subclasses for each logical operation (e.g., AddTileToHouseCommand, SetHouseExitCommand).</qt_object_notes>
  <additional_notes>The HouseBrush directly modifies tile properties. The HouseExitBrush's main logic is not a typical brush stroke but rather a targeted 'house-&gt;setExit()' call, likely triggered by a UI action after selecting a house and a target tile.</additional_notes>
  <estimation_effort>Large</estimation_effort>
</LOGIC-05>
